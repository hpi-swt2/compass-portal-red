<% content_for :title, "HPI Map" %>
<% content_for :head do %>
    <%= stylesheet_link_tag 'map' %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" />

    <% # Inject outdoor geometry & generate building data %>
    <%= javascript_pack_tag 'OutdoorMap/geometry' %>
    <script>
      window.roomsToBuild = [
          <% @buildings.each do |building|%>
          <% building.rooms.each do |room|%>
          {
              'id': '<%= room.id %>',
              'fullName': '<%= room.full_name %>',
              'geoJson': <%= raw(JSON.generate(room.to_geojson)) %>
          },
          <% end %>
          <% end %>
      ]
    </script>

    <% # Inject coordinates of selected room %>
    <script type="text/javascript" charset="utf-8">
        const selected_room_name = "<%= @selected_room? @selected_room.full_name : nil %>"
    </script>
  <% end %>

  <body>
  	<div class="leaflet">
  		<div id="map" style="width: 100%; height: 100%;"></div>
      <%= javascript_pack_tag 'OutdoorMap/map_build', 'data-turbolinks-track': 'reload' %>
      <%= javascript_pack_tag 'indoorMap', 'data-turbolinks-track': 'reload' %>
	  </div>

    <% if @selected_room.present? %>
	  <%= render 'partials/map_popup', :locals => {:room => @selected_room}%>
      <%= javascript_pack_tag 'selected_room', 'data-turbolinks-track': 'reload' %>
    <% end %>
  </body>
</html>